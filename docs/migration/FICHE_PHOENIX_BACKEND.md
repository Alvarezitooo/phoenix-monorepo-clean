# üìã FICHE PRODUIT : PHOENIX BACKEND UNIFIED

> **API centralis√©e FastAPI** pour servir Phoenix Aube (diagnostic carri√®re) + Phoenix Rise (Kaizen/Zazen) + authentification unifi√©e.

## üéØ **Essence Fonctionnelle**

Phoenix Backend Unified est le **hub central API** qui orchestre les donn√©es et services pour l'√©cosyst√®me Phoenix. Il g√®re l'authentification unifi√©e et expose les APIs m√©tier pour Phoenix Aube (exploration carri√®re) et Phoenix Rise (d√©veloppement personnel Kaizen/Zazen).

### **Proposition de Valeur**
- üéØ **API centralis√©e** - Single point of truth pour data ecosystem
- üîê **Auth unifi√©e** - JWT authentication service pour tous les clients
- üß† **Phoenix Aube** - Diagnostic et exploration carri√®re avec IA
- üßò **Phoenix Rise** - Tracking Kaizen et m√©ditation Zazen
- üìä **Analytics** - M√©triques cross-services et business intelligence
- ‚ö° **Performance** - FastAPI async avec middleware optimis√©s

## üèóÔ∏è **Architecture R√©elle**

### **Backend - FastAPI avec Routers Modulaires**
- **Port :** 8000
- **Framework :** FastAPI avec architecture modulaire
- **Database :** Supabase PostgreSQL avec ORM
- **Auth :** JWT avec middleware centralis√©
- **Deployment :** Railway avec health checks

### **Structure Modulaire**
```
routers/
‚îú‚îÄ‚îÄ health.py      # Health checks Railway
‚îú‚îÄ‚îÄ auth.py        # Authentification JWT unifi√©e
‚îú‚îÄ‚îÄ aube.py        # Phoenix Aube - Diagnostic carri√®re
‚îî‚îÄ‚îÄ rise.py        # Phoenix Rise - Kaizen/Zazen
```

### **Middleware Stack**
- **CORS :** Configuration s√©curis√©e multi-origins
- **TrustedHost :** Protection host header attacks
- **ErrorHandler :** Gestion erreurs personnalis√©e
- **Monitoring :** Logging et m√©triques requ√™tes

## üîó **Routers & Endpoints Critiques**

### **üîê Router Auth** (`/api/v1/auth`)
```python
class AuthService:
    - ‚úÖ JWT token generation & validation
    - ‚úÖ User registration & login
    - ‚úÖ Session management Supabase
    - ‚úÖ Password reset flows
    - ‚úÖ User profile management
    - ‚úÖ Tier management (FREE/PREMIUM)
```

**Endpoints Cl√©s :**
- `POST /api/v1/auth/register` - Inscription utilisateur
- `POST /api/v1/auth/login` - Connexion JWT
- `POST /api/v1/auth/refresh` - Refresh token
- `GET /api/v1/auth/me` - Profil utilisateur actuel
- `PUT /api/v1/auth/profile` - Mise √† jour profil

### **üéØ Router Aube** (`/api/v1/aube`) - Diagnostic Carri√®re

#### **Diagnostic Personnalit√© & Carri√®re**
```python
class DiagnosticService:
    - ‚úÖ Quiz personnalit√© MBTI-like
    - ‚úÖ Analyse IA r√©ponses utilisateur  
    - ‚úÖ G√©n√©ration matches m√©tiers avec scores
    - ‚úÖ √âvaluation r√©sistance IA des m√©tiers
    - ‚úÖ Recommandations personnalis√©es
```

**Endpoints M√©tier :**
- `POST /api/v1/aube/diagnostic/submit` - Soumission quiz personnalit√©
- `GET /api/v1/aube/career/matches/{user_id}` - R√©cup√©ration matches m√©tiers
- `POST /api/v1/aube/events` - Tracking √©v√©nements exploration
- `GET /api/v1/aube/recommendations/{user_id}` - Recommandations IA

**Mod√®les de Donn√©es :**
```python
DiagnosticQuestion:
    - id: str
    - question: str  
    - answer: str
    - category: str

CareerMatch:
    - title: str
    - match_score: int        # 0-100
    - ai_resilience: int      # Score r√©sistance IA
    - description: str
    - skills_required: List[str]
    - growth_potential: str
```

### **üßò Router Rise** (`/api/v1/rise`) - Kaizen & Zazen

#### **Kaizen - Actions d'am√©lioration continue**
```python
class KaizenService:
    - ‚úÖ Cr√©ation actions Kaizen quotidiennes
    - ‚úÖ Tracking completion avec timestamps
    - ‚úÖ Calcul streaks et statistiques
    - ‚úÖ Historique complet utilisateur
    - ‚úÖ Analytics progression
```

#### **Zazen - Sessions m√©ditation**  
```python
class ZazenService:
    - ‚úÖ Enregistrement sessions m√©ditation
    - ‚úÖ Tracking dur√©e et fr√©quence
    - ‚úÖ Triggers contextuels (stress, decision)
    - ‚úÖ Statistiques bien-√™tre
    - ‚úÖ Gamification progress
```

**Endpoints Kaizen :**
- `POST /api/v1/rise/kaizen` - Cr√©ation action Kaizen
- `GET /api/v1/rise/kaizen/{user_id}` - Historique actions
- `PUT /api/v1/rise/kaizen/{kaizen_id}` - MAJ statut completion
- `GET /api/v1/rise/kaizen/streak/{user_id}` - Streak actuelle

**Endpoints Zazen :**
- `POST /api/v1/rise/zazen-session` - Enregistrement session
- `GET /api/v1/rise/zazen-sessions/{user_id}` - Historique sessions
- `GET /api/v1/rise/zazen/stats/{user_id}` - Statistiques m√©ditation

**Endpoints Analytics :**
- `GET /api/v1/rise/stats/{user_id}` - Dashboard utilisateur complet

## üóÑÔ∏è **Mod√®les de Donn√©es Critiques**

### **Aube - Career Exploration Data**
```python
DiagnosticResult:
    - user_id: str
    - personality_profile: Dict[str, Any]
    - career_matches: List[CareerMatch]  
    - recommendations: List[str]
    - ai_insights: Dict[str, Any]
    - confidence_score: float
    - analysis_version: str
```

### **Rise - Personal Development Data**
```python
KaizenEntry:
    - id: int
    - user_id: str
    - action: str
    - date: str
    - completed: bool
    - created_at: datetime

ZazenSession:
    - id: int
    - user_id: str
    - timestamp: datetime
    - duration: int  # secondes
    - triggered_by: str
    - notes: str

UserStats:
    - totalKaizens: int
    - completedKaizens: int
    - completionRate: float
    - totalZazenMinutes: int
    - currentStreak: int
    - averageSessionDuration: float
```

## üîê **S√©curit√© & Middleware**

### **JWT Authentication** üìç `services/auth_service.py`
```python
class AuthService:
    - ‚úÖ JWT token generation avec expiration
    - ‚úÖ Refresh token rotation
    - ‚úÖ User session validation
    - ‚úÖ Password hashing bcrypt  
    - ‚úÖ Rate limiting per endpoint
    - ‚úÖ Brute force protection
```

### **CORS Configuration**
```python
CORS_SETTINGS:
    allow_origins: [
        "https://phoenix-aube.vercel.app",
        "https://phoenix-rise.vercel.app", 
        "https://phoenix-cv.vercel.app",
        "http://localhost:3000",  # Aube dev
        "http://localhost:3001"   # Rise dev
    ]
    allow_credentials: True
    allow_methods: ["*"]
    allow_headers: ["*"]
```

### **Security Middleware Stack**
- **TrustedHost :** Validation host headers
- **Rate Limiting :** Protection DoS par endpoint
- **Input Validation :** Pydantic models strict
- **SQL Injection :** ORM queries param√©tr√©es
- **Error Handler :** Sanitization error messages

### **User Ownership Validation**
```python
# Protection acc√®s donn√©es
async def verify_user_ownership(user_id: str, current_user: User):
    if current_user.id != user_id and not current_user.is_admin:
        raise HTTPException(403, "Acc√®s non autoris√©")
```

## üóÑÔ∏è **Base de Donn√©es - Supabase PostgreSQL**

### **Tables Auth & Users**
- **`users`** - Profils utilisateurs avec auth data
- **`user_sessions`** - Sessions JWT actives
- **`user_subscriptions`** - Abonnements Stripe cross-services

### **Tables Phoenix Aube**
- **`career_explorations`** - R√©sultats diagnostic personnalit√©
- **`career_matches`** - Matches m√©tiers avec scores
- **`exploration_analytics`** - √âv√©nements tracking exploration

### **Tables Phoenix Rise**  
- **`kaizen`** - Actions Kaizen avec tracking completion
- **`zazen_sessions`** - Sessions m√©ditation avec m√©triques
- **`user_streaks`** - Calcul streaks et gamification

### **Indexes Performance**
```sql
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_kaizen_user_date ON kaizen(user_id, date);  
CREATE INDEX idx_zazen_user_timestamp ON zazen_sessions(user_id, timestamp);
CREATE INDEX idx_career_matches_user ON career_matches(user_id);
```

## üîÑ **Business Logic Critique**

### **Diagnostic Carri√®re - Algorithme IA**
```python
def analyze_personality_responses(responses: List[DiagnosticQuestion]):
    """
    Algorithme analyse personnalit√© MBTI-like
    1. Scoring dimensions : E/I, N/S, T/F, J/P
    2. Mapping vers profils m√©tiers 
    3. Calcul compatibility scores
    4. √âvaluation r√©sistance IA secteurs
    5. G√©n√©ration recommandations personnalis√©es
    """
    personality_scores = calculate_mbti_dimensions(responses)
    career_matches = match_careers_to_personality(personality_scores)
    ai_resilience = calculate_ai_impact_scores(career_matches)
    return DiagnosticResult(...)
```

### **Kaizen Streak Calculation**
```python  
def calculate_kaizen_streak(user_id: str) -> int:
    """
    Calcul streak Kaizen bas√© sur completion quotidienne
    1. R√©cup√©ration actions 30 derniers jours
    2. Grouping par jour avec completion status
    3. Calcul streak cons√©cutive depuis aujourd'hui
    4. Reset √† 0 si gap dans les completions
    """
    daily_completions = get_daily_kaizen_completions(user_id, days=30)
    return calculate_consecutive_streak(daily_completions)
```

## üì¶ **D√©pendances Critiques**

### **Core FastAPI**
```bash
fastapi>=0.104.1                     # Framework API
uvicorn[standard]>=0.24.0            # ASGI server
pydantic>=2.5.0                      # Validation donn√©es
pydantic-settings>=2.0.3             # Configuration
```

### **Database & Storage**
```bash
supabase>=1.2.0                      # Database backend
asyncpg>=0.29.0                      # Async PostgreSQL
sqlalchemy>=2.0.23                   # ORM (optional)
```

### **Authentication & Security**
```bash
python-jose[cryptography]>=3.3.0     # JWT handling
passlib[bcrypt]>=1.7.4               # Password hashing
bcrypt>=4.0.1                        # Crypto backend
```

### **HTTP & Async**
```bash
httpx>=0.25.2                        # HTTP client async
aiohttp>=3.8.5                       # Alternative HTTP
python-multipart>=0.0.6              # Form handling
```

### **Monitoring & Logging**
```bash
structlog>=23.2.0                    # Structured logging
prometheus-client>=0.19.0            # Metrics collection
```

### **Packages Vendoris√©s (Locaux)**
```bash
-e ./vendor/phoenix-shared-models    # Mod√®les de donn√©es
-e ./vendor/phoenix-shared-auth      # Auth utilities
```

## üöÄ **Migration vers Monorepo Clean**

### **Adaptations N√©cessaires**
1. **üîÑ Suppression Shared Dependencies**
   - Remplacer imports `phoenix-shared-*` par modules locaux
   - Internaliser mod√®les auth et data
   
2. **üîß Configuration Autonome**
   - Variables environnement compl√®tes
   - Connexion Supabase directe
   - Secrets management Railway
   
3. **üì° Service Discovery**
   - Health checks pour monitoring
   - Service registry pour microservices
   - Load balancing configuration
   
4. **üóÑÔ∏è Database Migration**  
   - Migration sch√©mas existants Supabase
   - Index optimization pour performance
   - Backup strategy donn√©es critiques

### **Endpoints Migration Strategy**
1. **Phase 1 :** Auth endpoints (foundation)
2. **Phase 2 :** Aube diagnostic endpoints (business critical)  
3. **Phase 3 :** Rise Kaizen/Zazen endpoints (engagement)
4. **Phase 4 :** Analytics et reporting endpoints

### **Priority Migration : üü° MEDIUM**
Phoenix Backend est **infrastructure critique** mais moins prioritaire que les services front-end revenue-generating (Letters/CV). Migration apr√®s stabilisation services clients.

## üéØ **Production Considerations**

### **Performance Optimization**
- **Database :** Connection pooling et query optimization
- **Caching :** Redis pour donn√©es fr√©quemment acc√©d√©es
- **CDN :** Assets statiques et API responses
- **Monitoring :** APM pour tracking performance

### **Scalability**
- **Horizontal :** Multiple instances Railway avec load balancer
- **Database :** Read replicas pour queries lourdes
- **Queue :** Background jobs pour processing lourd
- **Rate Limiting :** Protection contre abuse et DoS

### **Security Hardening**
- **Secrets :** Variables environnement Railway encrypted
- **Database :** SSL connections et encryption at rest
- **API :** Rate limiting et DDoS protection
- **Monitoring :** Security events logging et alerting

---

üìù **Document g√©n√©r√© le :** `{{ datetime.now().isoformat() }}`
üîß **Pr√™t pour migration vers :** `phoenix-mono-clean/apps/phoenix-backend-unified/`